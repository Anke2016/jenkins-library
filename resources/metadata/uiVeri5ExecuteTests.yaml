metadata:
  name: uiVeri5ExecuteTests
  description: Executes UI5 e2e tests using uiVeri5
  longDescription: |
    In this step the ([UIVeri5 tests](https://github.com/SAP/ui5-uiveri5)) are executed.

#    The step is using the `seleniumExecuteTest` step to spin up two containers in a Docker network:
#    * a Selenium/Chrome container (`selenium/standalone-chrome`)
#    * a NodeJS container (`node:lts-stretch`)
#    In the Docker network, the containers can be referenced by the values provided in `dockerName` and `sidecarName`, the default values are `karma` and `selenium`. These values must be used in the `hostname` properties of the test configuration ([Karma](https://karma-runner.github.io/1.0/config/configuration-file.html) and [WebDriver](https://github.com/karma-runner/karma-webdriver-launcher#usage)).
#   !!! note
#        In a Kubernetes environment, the containers both need to be referenced with `localhost`.
spec:
  inputs:
    params:
      - name: installCommand
        type: string
        description: The command that is executed to install the uiveri5 test tool.
        default: npm install @ui5/uiveri5 --global --quiet
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
      - name: modulePath
        type: string
        description: Define the path of the module to execute tests on.
        default: "."
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
      - name: confPath
        type: string
        description: Define the path of the uiVeri5 conf.js.
        default: "./conf.js"
        scope:
          - PARAMETERS
          - STAGES
          - STEPS
      - name: runCommand
        type: string
        description: The command that is executed to start the tests.
        default: uiveri5 --seleniumAddress='http://localhost:4444/wd/hub'
        scope:
          - GENERAL
          - PARAMETERS
          - STAGES
          - STEPS
        mandatory: true
  #outputs:
  containers:
    - name: uiVeri5
      image: node:10.23.0-stretch #node:lts-stretch
      env:
        - name: no_proxy
          value: localhost,selenium,$no_proxy
        - name: NO_PROXY
          value: localhost,selenium,$NO_PROXY
      workingDir: /home/node
      # volumeMounts:
      #   - mountPath: /dev/shm
      #     name: dev-shm
  sidecars:
    - image: selenium/standalone-chrome
      name: selenium
      securityContext:
        privileged: true
      volumeMounts:
        - mountPath: /dev/shm
          name: dev-shm
      env:
        - name: "NO_PROXY"
          value: "localhost,karma,$NO_PROXY"
        - name: "no_proxy"
          value: "localhost,selenium,$no_proxy"
